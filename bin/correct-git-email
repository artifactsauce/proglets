#!/usr/bin/env bash

set -eu

. $(dirname $0)/../lib/bash/functions
. $(dirname $0)/../lib/bash/logger

usage() {
    cat <<EOF >&2
Usage: $(basename $0) OLD_EMAIL NEW_EMAIL
EOF
}

if [ $# -ne 2 ]; then
  logger.error "Required old and new email."
  usage
  false || exit
fi

OLD_EMAIL=$1 NEW_EMAIL=$2 git filter-branch --commit-filter '
  if [ "$GIT_AUTHOR_EMAIL" = "$OLD_EMAIL" -o "$GIT_COMMITTER_EMAIL" = "$OLD_EMAIL" ];
    then
      GIT_COMMITTER_EMAIL="$NEW_EMAIL";
      GIT_AUTHOR_EMAIL="$NEW_EMAIL";
      git commit-tree "$@";
  else
    git commit-tree "$@";
fi' HEAD
